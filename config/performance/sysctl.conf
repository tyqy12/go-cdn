# AI CDN Tunnel - 系统内核参数优化
# 目标: 10万+并发连接, 低延迟

# ==================== 文件描述符 ====================
# 最大文件描述符数
fs.file-max = 2097152
fs.nr_open = 2097152

# ==================== TCP参数 ====================
# TCP缓冲区
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.core.rmem_default = 262144
net.core.wmem_default = 262144
net.core.optmem_max = 16777216

# TCP内存
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216

# TCP连接
net.ipv4.tcp_max_syn_backlog = 65535
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0  # 禁用, 与NAT不兼容
net.ipv4.tcp_max_tw_buckets = 5000
net.ipv4.tcp_keepalive_time = 300
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 5

# TCP重传
net.ipv4.tcp_retries1 = 3
net.ipv4.tcp_retries2 = 8
net.ipv4.tcp_orphan_retries = 0

# TCP端口
net.ipv4.ip_local_port_range = 1024 65535

# TCP快速打开
net.ipv4.tcp_fastopen = 3

# TCP拥堵控制
net.ipv4.tcp_congestion_control = bbr

# ==================== 网络参数 ====================
# 连接队列
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 65535

# 禁用IP转发(如果不需要)
# net.ipv4.ip_forward = 0

# 禁用源路由
net.ipv4.conf.default.accept_source_route = 0

# 禁用重定向
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# 启用RP过滤
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# ==================== IPv6参数 ====================
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.ip_local_port_range = 1024 65535

# ==================== 内存管理 ====================
# 虚拟内存
vm.swappiness = 10
vm.dirty_ratio = 60
vm.dirty_background_ratio = 5
vm.min_free_kbytes = 1048576  # 1GB保留内存

# 大页
vm.nr_hugepages = 512
vm.hugetlb_shm_group = 0

# ==================== 调度 ====================
# CPU调度
kernel.sched_migration_cost_ns = 5000000
kernel.sched_latency_ns = 10000000
kernel.sched_min_granularity_ns = 1000000
kernel.sched_wakeup_granularity_ns = 1500000

# ==================== 应用 ====================
# 信号量
kernel.sem = 250 32000 100 1024

# 共享内存
kernel.shmmax = 68719476736
kernel.shmall = 4294967296

# 消息队列
msgmax = 8192
msgmnb = 16384
msgmni = 32768
