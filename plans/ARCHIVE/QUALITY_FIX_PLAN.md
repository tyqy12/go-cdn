# CDN系统代码质量修复计划

日期: 2026-01-03  
执行者: Codex

## 1. 背景与目标

当前代码已包含主控、Agent、CDN核心、缓存、监控、边缘计算等模块，但存在多处运行时崩溃风险、逻辑占位实现、统计口径不一致与并发资源不可控问题。本文档给出分阶段、可验证的修复计划，目标是提升系统稳定性、可维护性与功能一致性，确保关键路径可用且可测试。

## 2. 范围与非范围

**范围**
- 运行时崩溃与锁错误修复（panic、死锁、空指针）。
- 核心逻辑正确性修复（缓存命中、鉴权算法一致性、统计口径）。
- 并发与资源管理问题修复（goroutine 管控、执行上下文回收）。
- 基础测试补齐与验证流程明确。

**非范围**
- 新功能开发与架构重构。
- UI/前端功能扩展。
- 依赖升级与发布流程调整（除非修复需要）。

## 3. 主要问题清单（摘要）

| 严重级别 | 文件 | 问题描述 | 影响 |
| --- | --- | --- | --- |
| 严重 | `pkg/monitor/monitor.go` | 统计锁 `m.stats.mu` 加锁后解锁 `m.mu`，触发双重解锁与锁泄漏 | 运行期崩溃、统计不可用 |
| 严重 | `pkg/edge/computing.go` | `e.stats.mu` 加锁后解锁 `e.mu` | 执行失败分支崩溃 |
| 严重 | `pkg/edge/computing.go` | `QuickJSConfig/WASMConfig` 为空时解引用 | 运行期空指针 |
| 高 | `pkg/cache/advanced_cache.go` | `Get/Set` 为占位实现，缓存命中与存储不一致 | 功能失真、统计不可信 |
| 高 | `pkg/security/url_auth.go` | `md5` 分支实际使用 SHA256 | 鉴权不一致 |
| 高 | `pkg/edge/computing.go` | `executions` 只增不删 | 内存泄漏 |
| 中 | `pkg/cache/advanced_cache.go` | `TotalItems` 统计口径错误 | 指标误导 |
| 中 | `cmd/agent/main.go` | 命令处理无限制 goroutine | 资源风险 |
| 中 | 多处模块缺少测试 | 回归风险高 |

## 4. 修复原则

- **稳定性优先**：先处理崩溃与锁问题，再修正逻辑正确性。
- **最小改动**：不引入不必要重构，保持行为清晰可验证。
- **小步验证**：每个阶段均可单独验证，避免大范围回归。
- **可测试性**：关键路径至少具备可运行的单测或集成验证入口。

## 5. 分阶段修复计划

### 阶段A：崩溃类问题修复（必须优先）

**A1. 监控模块锁错误修复**  
- 文件: `pkg/monitor/monitor.go`  
- 目标: 修正 `AddSite/PauseSite/ResumeSite/DeleteSite` 中的锁/解锁对象，避免双重解锁与锁泄漏。  
- 验收: 
  - 相关函数不再发生 `sync: unlock of unlocked mutex`。
  - 统计更新在并发调用下稳定。

**A2. 边缘计算统计锁错误修复**  
- 文件: `pkg/edge/computing.go`  
- 目标: 在执行失败分支正确释放 `e.stats.mu`。  
- 验收: 
  - 执行失败不再触发 panic。  

**A3. 运行时配置空指针修复**  
- 文件: `pkg/edge/computing.go`  
- 目标: 初始化 QuickJS/WASM 时安全处理 `nil` 配置，确保默认值生效。  
- 验收:
  - 未配置 `QuickJSConfig/WASMConfig` 时可正常初始化。

### 阶段B：核心逻辑正确性修复

**B1. 缓存读写逻辑落地**  
- 文件: `pkg/cache/advanced_cache.go`  
- 目标: 
  - `Get` 从实际存储读取并校验过期。  
  - `Set` 写入存储、更新统计与存储容量。  
- 验收:
  - `Set` 后 `Get` 可命中并返回正确数据。  
  - 过期数据不会误命中。  

**B2. 鉴权算法一致性**  
- 文件: `pkg/security/url_auth.go`  
- 目标: `md5` 算法实现与配置一致（真实 MD5 或移除选项）。  
- 验收:
  - 指定 `md5` 时签名校验一致，不出现算法错配。  

**B3. 缓存统计口径修正**  
- 文件: `pkg/cache/advanced_cache.go`  
- 目标: `TotalItems` 统计应为缓存条目数而非存储数量。  
- 验收:
  - 指标与实际缓存条目一致。  

### 阶段C：资源与并发控制

**C1. 边缘执行上下文回收**  
- 文件: `pkg/edge/computing.go`  
- 目标: 执行结束后移除 `executions` 中的条目或引入容量上限与回收策略。  
- 验收:
  - 长时间运行时内存不随请求线性增长。  

**C2. Agent 命令执行并发控制**  
- 文件: `cmd/agent/main.go`  
- 目标: 为命令执行加入并发限制（如 worker 池或令牌）。  
- 验收:
  - 大量命令同时下发时不会造成 goroutine 失控。  

### 阶段D：测试与验证补齐

**D1. 主路径测试补齐**
- 建议覆盖模块:
  - `master/db`：存储读写与索引行为（可用内存或本地 DB mock）。  
  - `monitor`：站点增删、告警静默规则命中。  
  - `edge`：函数部署与执行成功/失败路径。  
  - `agent`：命令处理流程与超时处理。  
- 验收:
  - 关键逻辑具备最小可运行测试集。  

## 6. 验证与测试策略

**建议的验证方式**  
1. 单元测试: `go test ./...`  
2. 关键模块聚焦测试:  
   - `go test ./pkg/cache -run TestAdvancedCache`  
   - `go test ./pkg/edge -run TestEdgeComputing`  
   - `go test ./pkg/monitor -run TestAccessibilityMonitor`  

**验证重点**  
- 并发锁错误是否消失。  
- 缓存命中、过期、统计是否一致。  
- 边缘执行失败是否稳定返回错误而非崩溃。  

## 7. 风险与缓解

| 风险 | 说明 | 缓解措施 |
| --- | --- | --- |
| 改动影响范围大 | 修复触及多个核心模块 | 分阶段合并，优先修复崩溃点 |
| 测试不足 | 当前测试覆盖偏少 | 补齐最小可运行测试 |
| 历史占位逻辑依赖 | 现有调用可能依赖占位行为 | 明确行为变化并补充说明 |

## 8. 交付物

- 修复后的代码变更（按阶段提交）。  
- 新增或更新测试用例。  
- 本文档更新记录与执行结果。  

## 9. 跟踪建议

建议以阶段为单位跟踪进度，并在完成每个阶段后更新记录（日期、变更摘要、验证结果）。如需变更范围或引入新依赖，提前记录并同步评审。
